<script src="/socket.io/socket.io.js"></script>

<div class="container">

    <div class="page-header text-center">
        <h1><span class="fa fa-anchor"></span> Chat Page</h1>
		<a href="/profile" class="btn btn-default btn-sm">Profile</a>
		<a href="/management" class="btn btn-default btn-sm" id="management">Management</a>
		<a href="/logout" class="btn btn-warning btn-sm">Logout</a>
	</div>
	<label id="Id" hidden>{{user.id}}</label>
	<label id="Role" hidden>{{user.Role}}</label>
	<label id="DisplayName" hidden>{{user.DisplayName}}</label>
	<label id="username" hidden>{{user.UserName}}</label>

	<div class="row">
		<ul id="messages"></ul>
		<div id="message">
			<input type="text" id="msg" placeholder="type here to send"/>
			<button id="msgbutton" class="btn btn-default btn-success btn-sm " disabled>Send</button>
		</div>
	</div>
</div>

<script>
	var UserName = $('#username').text();
	var socket = io.connect();
	var geolocationEnabled = false;
	var sendAllowed = false;

	socket.emit("join", UserName);

	socket.on('join', function(User){
		$('#messages').append( '<li>The user ' + User.UserName + ' with name ' + User.DisplayName + ' joined the chat</li>');
	});

	socket.on('msg', function(line){
		var datearray = line.Datetime.split("T");
		var date = datearray[0];
		var time = datearray[1].split(".")[0];
		$('#messages').append( '<li>['+ date + ":" + time + '] ' + line.User.DisplayName + ': ' + line.Body + '</li>');	
	});



	function send(){
		if(sendAllowed){
	    	navigator.geolocation.getCurrentPosition(function(data){
	    		var lat = data.coords.latitude;
	    		var lon = data.coords.longitude;
	    		var id = $('#Id').text();
	    		var body = $('input').val();
	    		socket.emit('send msg', body, id, lat , lon);
	    		$('input').val('');
	    		$('#msgbutton').prop('disabled', true);
    			sendAllowed = false;
	   		});
		}
	}

	$("#msgbutton").click(function(){
		send();
	});
	$('#msg').keypress(function(e){
		if(e.which == 13){
			send();
		}
	});
    $('#msg').keyup(function() {
        if($(this).val() != '' && geolocationEnabled) {
    		$('#msgbutton').removeAttr('disabled');
    		sendAllowed = true;
		} else{
			$('#msgbutton').prop('disabled', true);
			sendAllowed = false;
        }
     });

	$(document).ready(function(){
		

	    if($('#Role').text()!= "Admin"){
	        $('#management').hide();
	    }
	    

	    if(navigator.geolocation){
	    	navigator.geolocation.getCurrentPosition(function(){
	    		geolocationEnabled = true;
	    	}, function(error){
	    		switch(error.code) {
		        case error.PERMISSION_DENIED:
		            alert("Geolocation must be enabled to chat");
		            break;
		        case error.POSITION_UNAVAILABLE:
		            alert("Location information is unavailable.");
		            break;
		        case error.TIMEOUT:
		            alert("The request to get user location timed out.");
		            break;
		        case error.UNKNOWN_ERROR:
		            alert("An unknown error occurred.");
		            break;
		   		}
	    	});
	    } else{
	    	alert('Your browser doesn\'t support location');
	    	geolocationEnabled = false;
	    }
	    
	        
	    
		
    });
</script>



